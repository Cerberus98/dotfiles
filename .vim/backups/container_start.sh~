#!/bin/bash

echo "Getting current default gw"
GATEWAY_IP=$(ip -4 route list 0/0 | cut -d ' ' -f 3)

echo "Connecting to VPN..."
vpnc-connect

echo "Remove the new gateway, and put the old into place"
route del default dev tun0
route add -net 192.168.0.0 netmask 255.255.0.0 dev tun0
route add default gw $GATEWAY_IP dev eth0

endpoint="192.168.1.3" # endpoint 

echo 'Starting forwarder/proxy..'
/bin/bash proxy-161.sh &
/bin/bash proxy-162.sh &

test_connection(){
  count=$( ping -c 3 $endpoint | grep icmp* | wc -l )
  if [ $count -eq 0 ] 
      then
      # Ping failed
      echo "Ping FAILED $(date) for $endpoint"
      echo 'Reconnecting to VPN...'
      vpnc-connect
      route del default dev tun0
      route add -net 192.168.0.0 netmask 255.255.0.0 dev tun0
      route add default gw $GATEWAY_IP dev eth0
  else
    echo "Ping replied $(date) from $endpoint"
  fi
}

while : 

do
test_connection
sleep 30
done
