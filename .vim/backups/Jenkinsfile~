#!groovy
pipeline {
  agent { label 'ci-runner' }
  options {
    timeout(time: 30, unit: 'MINUTES')
  }
  stages {
    stage('Clean workspace') {
      steps {
        sh '''
          make clean
        '''
      }
    }
    stage('Check') {
      steps {
        sh '''
          make check
        '''
      }
    }
    stage('Test') {
      steps {
        sh '''
          make test
        '''
      }
    }
    stage('Test with included Inventory data') {
      steps {
        sh '''
          export INVENTORY_FILEPATH=tranquility/inventory.yaml
          make test
        '''
      }
    }
    stage('Python package: build package') {
      steps {
        sh '''
          make build
        '''
      }
    }
    stage('Build and push tranquility docker image') {
      steps {
        withCredentials([[$class: "UsernamePasswordMultiBinding",
                  credentialsId: "harmony-tranquility-repo",
                  usernameVariable: "USERNAME",
                  passwordVariable: "PASSWORD"]]) {
          sh '''
            set +x
            docker login --username "$USERNAME" --password="$PASSWORD" registry-write.ci.dfj.io
            set -x
            make build-container push-container clean-container
          '''
        }
      }
    }
    stage('Python package: upload to devpi') {
      steps {
        withCredentials([[$class: "UsernamePasswordMultiBinding",
                          credentialsId: "harmony-tranquility-devpi-premerge",
                          usernameVariable: "USERNAME",
                          passwordVariable: "PASSWORD"]]) {
          sh '''
              devpi use https://pypi.ci.dfj.io/harmony_tranquility_premerge/premerge
              set +x
              devpi login "$USERNAME" --password="$PASSWORD"
              set -x
              devpi upload dist/*
          '''
        }
      }
    }
  }
}
