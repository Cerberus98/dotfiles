# #!/bin/sh
#

# TODO we can probably figure out which interface is the NAT'd interface here and then get that IP
VM_IFACE_NUMBER=1
VM_NAME="Mactunnel"
VPN_GATEWAY=`VBoxManage guestproperty get $VM_NAME /VirtualBox/GuestInfo/Net/$VM_IFACE_NUMBER/V4/IP | awk '{print $2}'`
DEVICE_NAME=`netstat -nr | grep default | head -n1 | awk '{print $6}'`
NETWORK_IFACE=`sudo networksetup -listallhardwareports | grep -C1 $DEVICE_NAME | head -n1 | cut -d' ' -f3-`

def_route=`netstat -rn | grep default | head -1 | awk '{ print $2 }'`
nameserver=`cat /etc/resolv.conf | egrep '^nameserver ' | head -1 | awk '{ print $2 }'`

# TODO We might need to only have the Tunnel IP here. Some things weren't working correctly
NAMESERVERS="$VPN_GATEWAY $nameserver"

# # Just so that the script will not ask for passwd
# # again later when we need to sudo a bunch of times
sudo echo

echo "Default route: $def_route"
echo "Nameserver: $NAMESERVERS"
echo "Gateway: $VPN_GATEWAY"
echo "Device name: $DEVICE_NAME"
echo "Network Interface: $NETWORK_IFACE"
echo "Updating DNS and routes..."

# # Set nameserver for VPN connection to be the one in /etc/resolv.conf
 sudo networksetup -setdnsservers "$NETWORK_IFACE" $NAMESERVERS
 
destination=$VPN_GATEWAY
# 
route='sudo route -n'
# 
echo "Deleting default route"
$route delete default
echo "Flushing routes"
$route -n flush
echo "Adding our default route back"
$route add default $def_route
echo "Adding Cisco routes to tunnel vm"
# 
# # TODO these routes worked every time
# $route -n add -net 10.1.0.0/16 $destination
# $route -n add -net 10.1.10.0/24 $destination
# $route -n add -net 10.1.10.1/32 $destination
# $route -n add -net 10.1.10.228/32 $destination
# $route -n add -net 10.1.10.255/32 $destination
$route -n add -net 10.203.0.0/16 $destination
$route -n add -net 10.23.0.0/16 $destination
$route -n add -net 10.24.0.0/16 $destination
# $route -n add -net 10.8.0.0/13 $destination
# $route -n add -net 10.16.0.0/12 $destination
$route -n add -net 10.18.179.0/24 $destination
$route -n add -net 10.30.119.0/24 $destination
# $route -n add -net 10.32.0.0/11 $destination
# $route -n add -net 10.64.0.0/10 $destination
# $route -n add -net 10.128.0.0/9 $destination
# $route -n add -net 10.203.0.0/16 $destination
# $route -n add -net 12.5.186.0/23 $destination
# $route -n add -net 12.19.88.0/21 $destination
# $route -n add -net 12.46.104.0/23 $destination
# $route -n add -net 12.130.27.0/24 $destination
# $route -n add -net 12.159.148.0/22 $destination
# $route -n add -net 12.196.199.0/24 $destination
# $route -n add -net 24.137.207.0/25 $destination
# $route -n add -net 38.169.198.0/23 $destination
# $route -n add -net 38.208.232.0/24 $destination
# $route -n add -net 38.246.124.0/23 $destination
# $route -n add -net 46.21.102.44/30 $destination
# $route -n add -net 63.67.142.0/24 $destination
# $route -n add -net 63.82.145.0/24 $destination
# $route -n add -net 63.97.62.0/23 $destination
# $route -n add -net 63.241.64.0/23 $destination
# $route -n add -net 63.241.93.0/24 $destination
# $route -n add -net 63.251.8.0/23 $destination
$route -n add -net 64.58.173.0/24 $destination
$route -n add -net 64.68.96.0/19 $destination
$route -n add -net 64.100.0.0/16 $destination
$route -n add -net 64.101.0.0/16 $destination
$route -n add -net 64.103.0.0/16 $destination
$route -n add -net 64.104.0.0/16 $destination
$route -n add -net 64.148.82.0/24 $destination
$route -n add -net 64.161.216.128/25 $destination

# # TODO I left these disabled in testing before too
# # $route -n add -net 65.195.91.0/24 $destination
# # $route -n add -net 66.26.34.128/27 $destination
# # $route -n add -net 66.26.34.160/27 $destination
# # $route -n add -net 66.126.210.0/24 $destination
# # $route -n add -net 66.161.11.0/25 $destination
# # $route -n add -net 66.187.208.0/20 $destination
# # $route -n add -net 67.148.157.128/26 $destination
# # $route -n add -net 71.140.40.144/28 $destination
$route -n add -net 72.163.0.0/16 $destination
# # $route -n add -net 83.241.162.136/29 $destination
# # $route -n add -net 91.212.94.0/24 $destination
# # $route -n add -net 91.234.201.0/24 $destination
# # $route -n add -net 103.60.32.0/22 $destination
# 
# # TODO These seem to break shit. I get 127 and 129, but 134?
# # $route -n add -net 127.0.0.0/24 $destination
# # $route -n add -net 128.107.0.0/32 $destination
# # $route -n add -net 134.24.132.0/22 $destination
# 
# $route -n add -net 144.254.0.0/32 $destination
# $route -n add -net 159.253.24.12/30 $destination
# $route -n add -net 161.44.0.0/32 $destination
# 
# # TODO This route definitely breaks shit
# # $route -n add -net 171.68.0.0/14 $destination
$route -n add -net 171.70.111.0/24 $destination
$route -n add -net 171.70.124.0/24 $destination

# # TODO This works ok
$route -n add -net 171.71.0.0/16 $destination

$route -n add -net 172.16.0.0/16 $destination
$route -n add -net 172.29.0.0/16 $destination
$route -n add -net 173.36.0.0/16 $destination
$route -n add -net 173.37.0.0/16 $destination
$route -n add -net 173.243.6.0/23 $destination
$route -n add -net 173.243.8.0/22 $destination
# 
# # TODO These might be problematic, all the way to the bottom
# # $route -n add -net 184.94.240.0/20 $destination
# # $route -n add -net 192.31.7.0/32 $destination
# # $route -n add -net 192.118.32.0/22 $destination
# # $route -n add -net 192.118.76.0/22 $destination
# # $route -n add -net 192.122.173.0/32 $destination
# # $route -n add -net 192.122.174.0/32 $destination
# # $route -n add -net 192.131.244.0/32 $destination
# # $route -n add -net 192.133.144.0/20 $destination
# # $route -n add -net 192.133.160.0/19 $destination
# # $route -n add -net 192.133.192.0/19 $destination
# # $route -n add -net 192.133.224.0/20 $destination
# # $route -n add -net 192.133.240.0/22 $destination
# # $route -n add -net 192.135.239.0/32 $destination
# # $route -n add -net 192.135.240.0/21 $destination
# # $route -n add -net 192.135.248.0/22 $destination
# # $route -n add -net 195.33.130.64/28 $destination
# # $route -n add -net 195.145.90.16/29 $destination
# # $route -n add -net 196.25.175.0/26 $destination
# # $route -n add -net 198.41.8.0/21 $destination
# # $route -n add -net 198.62.154.0/32 $destination
# # $route -n add -net 198.92.0.0/18 $destination
# # $route -n add -net 198.133.219.0/32 $destination
# # $route -n add -net 198.135.0.0/21 $destination
# # $route -n add -net 198.148.79.0/32 $destination
# # $route -n add -net 198.207.208.0/32 $destination
# # $route -n add -net 199.106.70.0/32 $destination
# # $route -n add -net 203.21.7.0/32 $destination
# # $route -n add -net 203.38.55.128/27 $destination
# # $route -n add -net 204.69.198.0/23 $destination
# # $route -n add -net 204.69.200.0/23 $destination
# # $route -n add -net 204.144.170.0/23 $destination
# # $route -n add -net 206.16.30.0/23 $destination
# # $route -n add -net 206.16.154.0/23 $destination
# # $route -n add -net 207.213.194.0/32 $destination
# # $route -n add -net 208.90.61.170/32 $destination
# # $route -n add -net 208.195.154.0/32 $destination
# # $route -n add -net 208.212.158.0/32 $destination
# # $route -n add -net 208.246.45.0/32 $destination
# # $route -n add -net 208.253.220.0/23 $destination
# # $route -n add -net 209.31.143.0/32 $destination
# # $route -n add -net 209.82.96.192/27 $destination
# # $route -n add -net 209.197.192.0/19 $destination
# # $route -n add -net 209.251.187.96/27 $destination
# # $route -n add -net 212.157.45.32/27 $destination
# # $route -n add -net 212.179.40.0/32 $destination
# # $route -n add -net 213.86.188.0/25 $destination
# # $route -n add -net 213.115.48.240/28 $destination
# # $route -n add -net 216.13.201.68/30 $destination
# # $route -n add -net 216.128.32.0/19 $destination
# # $route -n add -net 216.141.32.0/22 $destination
# # $route -n add -net 216.148.52.0/22 $destination
# # $route -n add -net 216.200.166.0/32 $destination
# # $route -n add -net 239.0.0.0/8 $destination
# # $route -n add -net 245.0.0.0/16 $destination
# 

