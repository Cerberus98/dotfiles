#!/bin/bash

if [ ! $# -eq 2 ]; then
    echo "Usage: OUTPUT_PATH CERTIFICATE_SUBJECT"
    exit 1
fi

BASE_OUTPUT_PATH=$1
SUBJECT="/CN=$2"
CERTS_PATH=${BASE_OUTPUT_PATH}/ssl

KEY_COMPLEXITY=2048
CA_DAYS=10000
CSR_DAYS=1000
CA_KEY=$CERTS_PATH/ca.key
CA_CRT=$CERTS_PATH/ca.crt
SERVER_KEY=$CERTS_PATH/server.key
SERVER_CSR=$CERTS_PATH/server.csr
SERVER_CRT=$CERTS_PATH/server.crt

mkdir -p $CERTS_PATH
openssl genrsa -out $CA_KEY $KEY_COMPLEXITY
openssl req -x509 -new -nodes -key $CA_KEY -subj $SUBJECT -days $CA_DAYS -out $CA_CRT
echo "WHAT"
openssl genrsa -out $SERVER_KEY $KEY_COMPLEXITY
echo "WATMAN"
openssl req -new -key $SERVER_KEY -out $SERVER_CSR -subj ${SUBJECT}
echo "WATAPOTTAMUS"
openssl x509 -req -in $SERVER_CSR -CA $CA_CRT -CAkey $CA_KEY -CAcreateserial -out $SERVER_CRT -days $CSR_DAYS
